# 运营级管理后台 - 核心功能详解指南

**文档类型**: 完整功能详解手册  
**目标读者**: 项目经理、产品负责人、技术负责人、运营人员  
**文档用途**: 全面了解后台核心功能与实现方案  
**版本**: V1.0  
**日期**: 2025-12-13

---

## 📋 文档说明

本文档详细介绍真人荷官视讯管理后台的**五大核心功能类别**，每个类别包含：
- 功能概述与核心价值
- 完整功能清单
- 详细实现方案（UI设计 + 技术方案）
- 预期收益分析

### 文档结构

| 章节 | 功能类别 | 核心定位 | 功能数量 |
|------|---------|---------|---------|
| 第一章 | 效率类功能 | 让运营「快」起来 | 7个功能 |
| 第二章 | 流程与控制类功能 | 让运营「稳」起来 | 8个功能 |
| 第三章 | 安全与风控功能 | 让运营「敢」操作 | 5个功能 |
| 第四章 | 真人视讯垂直功能 | 解决核心业务问题 | 8个功能 |
| 第五章 | 数据与决策支持功能 | 让运营「懂」数据 | 6个功能 |

**总计**: 34个核心功能

---

# 第一章：效率类功能 - 让运营「快」起来

## 📋 功能概述

效率类功能旨在**大幅减少运营人员的重复操作**，通过批量处理、快捷操作、智能筛选等手段，将日常工作效率提升 **50-80%**。

### 核心价值
- ⚡ **减少重复劳动** - 从逐条处理到批量操作
- 🚀 **提升处理速度** - 从小时级到分钟级
- 💪 **降低操作疲劳** - 从重复点击到一键完成
- 📊 **优化数据管理** - 从手动录入到批量导入

---

## 功能清单

| 功能编号 | 功能名称 | 核心价值 | 优先级 |
|---------|---------|---------|--------|
| 1.1.1 | 批量状态变更 | 批量启用/禁用玩家/代理账户 | 🔥🔥🔥 |
| 1.1.2 | 批量审核 | 批量审核提款/洗码申请 | 🔥🔥🔥 |
| 1.1.3 | 高级筛选与搜索 | AND/OR组合筛选、快速视图 | 🔥🔥 |
| 1.1.4 | 快速预览 | 无需跳转查看详情 | 🔥🔥 |
| 1.1.8 | Excel/CSV批量导入 | 批量导入玩家/代理数据 | 🔥🔥 |
| 1.1.9 | 导入错误预检 | 上传前验证并提示错误 | 🔥🔥 |
| 1.1.10 | 自定义字段导出 | 按需选择导出字段 | 🔥🔥 |

---

## 1.1.2 批量审核 🔥🔥🔥

### 当前痛点
- 每天有 **50-100笔** 提款申请需要审核
- 只能逐条点击"通过"或"拒绝"
- 运营人员每天花费 **2-3小时** 在重复点击上
- 高峰期审核堆积，玩家等待时间长

### 功能设计

**提款审核页面 - 批量操作**
```
┌─────────────────────────────────────────────────────┐
│ 提款审核管理                                         │
├─────────────────────────────────────────────────────┤
│ [√] 全选  待审核提款申请 (共127笔)  已选择：3笔     │
│                                                     │
│ 筛选：金额 [100-1000] ▼  状态 [待审核] ▼           │
│ [查询] [重置]                                        │
├─────────────────────────────────────────────────────┤
│ [√] | ID    | 玩家账号  | 金额    | 申请时间         │
├─────────────────────────────────────────────────────┤
│ [√] | 10001 | player123 | ¥500   | 12-13 14:30     │
│ [√] | 10002 | player456 | ¥1,200 | 12-13 14:25     │
│ [√] | 10003 | player789 | ¥800   | 12-13 14:20     │
├─────────────────────────────────────────────────────┤
│ 已选择 3 笔，总金额：¥2,500                          │
│ [批量通过] [批量拒绝] [取消选择]                     │
└─────────────────────────────────────────────────────┘
```

### 技术实现

**后端API**
```typescript
// 批量审核提款 API
app.put('/api/withdrawals/batch', async (c) => {
  const { DB } = c.env
  const { ids, action, operator_id } = await c.req.json()
  
  // 验证所有ID存在且状态为pending
  const withdrawals = await DB.prepare(`
    SELECT * FROM withdrawals 
    WHERE id IN (${ids.map(() => '?').join(',')}) 
    AND status = 'pending'
  `).bind(...ids).all()
  
  // 批量更新状态
  const newStatus = action === 'approve' ? 'approved' : 'rejected'
  await DB.prepare(`
    UPDATE withdrawals 
    SET status = ?, approved_by = ?, approved_at = CURRENT_TIMESTAMP
    WHERE id IN (${ids.map(() => '?').join(',')})
  `).bind(newStatus, operator_id, ...ids).run()
  
  // 审计日志
  for (const id of ids) {
    await DB.prepare(`
      INSERT INTO audit_logs (operator_id, module, action, target_id)
      VALUES (?, 'withdrawal', 'batch_${action}', ?)
    `).bind(operator_id, id).run()
  }
  
  return c.json({ success: true, count: ids.length })
})
```

### 预期收益
- ✅ 审核效率提升 **80%**
- ✅ 每天节省运营人员 **1.5-2小时**
- ✅ 高峰期处理能力提升 **3-5倍**

---

## 1.1.1 批量状态变更 🔥🔥🔥

### 业务场景
- **活动推广**: 批量调整玩家VIP等级、洗码方案
- **风控处理**: 批量禁用/冻结问题账户
- **代理管理**: 批量启用/禁用代理账户

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 玩家管理 - 批量操作                                  │
├─────────────────────────────────────────────────────┤
│ 已选择 15 个玩家                                     │
│                                                     │
│ 批量操作：                                           │
│ [批量启用] [批量禁用] [批量冻结]                     │
│ [设置VIP等级] [设置洗码方案] [转移代理]              │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 运营效率提升 **80%**
- ✅ 风控处理时间从 **30分钟** 降到 **5分钟**

---

## 1.1.3 高级筛选与搜索 🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 玩家管理 - 高级筛选                                  │
├─────────────────────────────────────────────────────┤
│ 快速视图：                                           │
│ [全部] [活跃玩家] [VIP玩家] [问题账户]              │
│                                                     │
│ 自定义筛选：                                         │
│ 条件1: [VIP等级 ▼] [等于 ▼] [VIP3 ▼]  [AND ▼]     │
│ 条件2: [余额 ▼] [大于 ▼] [1000]  [AND ▼]           │
│ 条件3: [最近充值 ▼] [在...内 ▼] [7天 ▼]            │
│                                                     │
│ [+ 添加条件] [清空] [保存为快速视图]                 │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 查询效率提升 **90%**
- ✅ 支持复杂的组合条件筛选

---

## 1.1.8 Excel/CSV批量导入 🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 批量导入玩家 - 步骤 1/3: 下载模板                   │
├─────────────────────────────────────────────────────┤
│ [📥 下载Excel模板] [📥 下载CSV模板]                 │
│                                                     │
│ 步骤 2/3: 上传文件                                   │
│ [选择文件] players_import.xlsx                      │
│                                                     │
│ 步骤 3/3: 验证结果                                   │
│ ✅ 格式正确：195 条                                  │
│ ⚠️ 格式错误：5 条                                   │
│                                                     │
│ 错误详情：                                           │
│ 第12行：手机号格式错误                               │
│ 第45行：VIP等级超出范围                              │
│                                                     │
│ [下载错误报告] [忽略错误继续导入]                    │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 数据迁移效率提升 **90%**
- ✅ 支持大批量数据导入（1000条/次）

---

## 1.1.10 自定义字段导出 🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 玩家数据导出 - 选择导出字段                          │
├─────────────────────────────────────────────────────┤
│ 基础信息：                                           │
│ [√] 玩家ID  [√] 用户名  [√] 真实姓名                │
│                                                     │
│ 财务信息：                                           │
│ [√] 当前余额  [√] 累计充值  [√] 累计提款            │
│                                                     │
│ 游戏信息：                                           │
│ [√] VIP等级  [√] 累计投注  [ ] 累计输赢             │
│                                                     │
│ 导出格式：                                           │
│ (•) Excel (.xlsx)  ( ) CSV (.csv)                   │
│                                                     │
│ [保存为导出模板] [开始导出]                          │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 导出效率提升 **70%**
- ✅ 文件大小减少 **50-80%**

---

# 第二章：流程与控制类功能 - 让运营「稳」起来

## 📋 功能概述

流程与控制类功能旨在**建立规范的操作流程**，通过审核工作流、系统配置、功能开关等手段，确保运营操作的**规范性、可控性、稳定性**。

### 核心价值
- 🛡️ **规范操作流程** - 从随意操作到流程化管理
- ⚡ **紧急响应能力** - 从小时级到秒级响应
- 🎯 **灵活配置管理** - 从硬编码到动态配置
- 📋 **标准化处理** - 从人工决策到模板化操作

---

## 功能清单

| 功能编号 | 功能名称 | 核心价值 | 优先级 |
|---------|---------|---------|--------|
| 2.1.1 | 审核工作流 | 任务分配、快速反馈、历史对比 | 🔥🔥 |
| 2.1.3 | 拒绝原因模版 | 快速选择拒绝原因 | 🔥🔥 |
| 2.1.5 | 历史违规记录 | 审核时显示历史情况 | 🔥🔥 |
| 2.2.3 | 系统参数配置 | 后台配置业务参数 | 🔥🔥🔥 |
| 2.2.4 | 文案配置 | 后台配置系统提示语 | 🔥🔥 |
| 2.2.6 | 功能开关 | 一键开启/关闭系统功能 | 🔥🔥🔥 |
| 2.2.7 | 维护模式 | 开启维护模式并显示公告 | 🔥🔥🔥 |
| 2.2.8 | 通知推送系统 | 定向推送、分组发送 | 🔥🔥 |

---

## 2.2.6 功能开关 🔥🔥🔥

### 当前痛点
- 发现重大Bug需要紧急关闭功能时，**必须修改代码重新部署**
- 系统维护时无法临时关闭充值/提款入口
- 夜间出现问题时，开发人员需要**紧急上线**

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 功能开关管理                                         │
├─────────────────────────────────────────────────────┤
│ [√] 充值功能     [启用中]  [关闭]                   │
│     └─ 关闭后玩家无法进行充值操作                    │
│                                                     │
│ [√] 提款功能     [启用中]  [关闭]                   │
│     └─ 关闭后玩家无法提交提款申请                    │
│                                                     │
│ [√] 游戏投注     [启用中]  [关闭]                   │
│     └─ 关闭后玩家无法进行游戏投注                    │
│                                                     │
│ [ ] 代理注册     [已关闭]  [启用]                   │
│     └─ 关闭后无法注册新代理                          │
└─────────────────────────────────────────────────────┘
```

### 技术实现

**数据库设计**
```sql
CREATE TABLE system_toggles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  toggle_key TEXT UNIQUE NOT NULL,
  toggle_name TEXT NOT NULL,
  is_enabled INTEGER DEFAULT 1,
  disabled_reason TEXT,
  last_modified_by INTEGER,
  last_modified_at DATETIME
);
```

**中间件检查**
```typescript
function checkToggle(toggleKey: string) {
  return async (c, next) => {
    const { DB } = c.env
    const toggle = await DB.prepare(`
      SELECT is_enabled FROM system_toggles WHERE toggle_key = ?
    `).bind(toggleKey).first()
    
    if (!toggle || !toggle.is_enabled) {
      return c.json({ error: '该功能暂时关闭' }, 403)
    }
    
    await next()
  }
}

// 应用到API
app.post('/api/deposits', checkToggle('deposit'), async (c) => {
  // 充值逻辑
})
```

### 预期收益
- ✅ 紧急情况下 **秒级响应**
- ✅ 运营人员可自主控制，无需等待开发

---

## 2.2.7 维护模式 🔥🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 维护模式控制中心                                     │
├─────────────────────────────────────────────────────┤
│ 当前状态：(•) 已启用                                 │
│                                                     │
│ 维护公告：                                           │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 尊敬的用户：                                    │ │
│ │ 系统将进行升级维护。                            │ │
│ │ 维护时间：2025-12-13 22:00 - 24:00 (预计2小时) │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 预计恢复时间：[2025-12-13] [24:00]                  │
│                                                     │
│ 维护期间效果：                                       │
│ [√] 玩家前端显示维护公告                             │
│ [√] 禁止玩家登录                                     │
│ [ ] 管理员可正常登录                                 │
│ [√] 自动恢复                                         │
│                                                     │
│ [预览效果] [开启维护模式]                            │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 系统维护时体验更专业
- ✅ 自动定时恢复，无需手动干预

---

## 2.2.3 系统参数配置 🔥🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 系统参数配置                                         │
├─────────────────────────────────────────────────────┤
│ 财务参数：                                           │
│   最小充值金额：    [100] 元                        │
│   最小提款金额：    [200] 元                        │
│   提款手续费率：    [0.5] %                         │
│   每日提款次数限制：[3] 次                          │
│                                                     │
│ 游戏参数：                                           │
│   默认洗码率：      [0.6] %                         │
│   最大投注金额：    [50000] 元                      │
│                                                     │
│ 联系方式：                                           │
│   客服电话：        [400-xxx-xxxx]                  │
│   客服微信：        [kefu_xxx]                      │
│                                                     │
│ [保存配置] [恢复默认]                                │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 无需修改代码即可调整业务参数
- ✅ 运营可自主配置，响应更快

---

## 2.1.3 拒绝原因模版 🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 拒绝提款申请 - 选择原因                              │
├─────────────────────────────────────────────────────┤
│ 常用原因模板：                                       │
│ • 流水不足 (使用23次)                               │
│   └─ [使用此模板]                                   │
│ • 银行卡信息不符 (使用18次)                         │
│   └─ [使用此模板]                                   │
│ • 重复提款 (使用12次)                               │
│   └─ [使用此模板]                                   │
│                                                     │
│ 详细说明（可选）：                                   │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 充值¥1000需完成1倍流水，当前¥600，还需¥400     │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ [取消] [确认拒绝]                                    │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 审核效率提升 **50%**
- ✅ 规范化拒绝原因

---

## 2.1.5 历史违规记录 🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 提款审核 - 玩家详情                                  │
├─────────────────────────────────────────────────────┤
│ ⚠️ 历史违规记录（共3条）                             │
│                                                     │
│ 2025-12-10 15:30                                    │
│ 类型：[提款异常]                                     │
│ 描述：提交虚假银行卡信息                             │
│ 处理：拒绝提款，警告处理                             │
│                                                     │
│ 2025-12-05 10:15                                    │
│ 类型：[刷水嫌疑]                                     │
│ 描述：与账户ID1234、ID5678同IP对打                  │
│ 处理：标记观察，限制VIP升级                          │
│                                                     │
│ 风控建议：                                           │
│ 💡 该玩家有3次违规记录，建议加强审核                 │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 审核决策更准确
- ✅ 减少重复违规风险

---

# 第三章：安全与风控功能 - 让运营「敢」操作

## 📋 功能概述

安全与风控功能旨在**建立完善的审计追溯体系**和**智能风险防控机制**，让运营人员在操作时更有安全感，同时保护平台利益。

### 核心价值
- 🔒 **完整审计追溯** - 所有操作可追踪、可回溯
- 🛡️ **高危操作保护** - 二次确认、软删除、回滚
- 🚨 **实时风险预警** - 自动识别异常行为
- 📊 **数据变更对比** - 精准定位问题根源

---

## 功能清单

| 功能编号 | 功能名称 | 核心价值 | 优先级 |
|---------|---------|---------|--------|
| 3.1.2 | 详细操作记录 | 确保所有敏感操作均记录 | 🔥🔥🔥 |
| 3.1.3 | 数据变更对比 | 记录修改前后的数据对比 | 🔥🔥🔥 |
| 3.1.4 | 日志查询界面 | 可视化查询操作日志 | 🔥🔥🔥 |
| 3.2.1 | 高危操作二次确认 | 密码或文本验证 | 🔥🔥🔥 |
| 3.2.2 | 软删除与回收站 | 数据误删除可恢复 | 🔥🔥 |

---

## 3.1.4 操作日志查询界面 🔥🔥🔥

### 当前痛点
- 出现数据异常时，无法快速查询"谁改了什么"
- 需要开发人员直接查询数据库
- 没有可视化界面，追溯困难

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 系统设置 → 操作日志                                  │
├─────────────────────────────────────────────────────┤
│ 筛选条件：                                           │
│ 操作人：[admin ▼]  模块：[全部 ▼]                   │
│ 时间：[最近7天 ▼]  操作：[全部 ▼]                   │
│ [查询] [重置]                                        │
├─────────────────────────────────────────────────────┤
│ 操作日志列表                                         │
├─────────────────────────────────────────────────────┤
│ 时间 | 操作人 | 模块 | 操作 | 详情                  │
├─────────────────────────────────────────────────────┤
│ 12-01 14:30 | admin | 玩家 | 修改 |                 │
│ 玩家ID:1234 余额：100.00 → 200.00                   │
│ [查看详情]                                           │
├─────────────────────────────────────────────────────┤
│ 12-01 14:25 | admin | 财务 | 审核 |                 │
│ 提款ID:5678 状态：pending → approved                │
│ [查看详情]                                           │
└─────────────────────────────────────────────────────┘
```

### 技术实现
```typescript
// 查询操作日志 API
app.get('/api/audit-logs', async (c) => {
  const { DB } = c.env
  const { operator, module, start_date, end_date } = c.req.query()
  
  let whereClause = 'WHERE 1=1'
  const params = []
  
  if (operator) {
    whereClause += ' AND operator_id = ?'
    params.push(operator)
  }
  if (module) {
    whereClause += ' AND module = ?'
    params.push(module)
  }
  if (start_date && end_date) {
    whereClause += ' AND created_at BETWEEN ? AND ?'
    params.push(start_date, end_date)
  }
  
  const logs = await DB.prepare(`
    SELECT l.*, u.username as operator_name
    FROM audit_logs l
    LEFT JOIN users u ON l.operator_id = u.id
    ${whereClause}
    ORDER BY l.created_at DESC
    LIMIT 100
  `).bind(...params).all()
  
  return c.json({ logs: logs.results })
})
```

### 预期收益
- ✅ 问题追溯时间从 **30分钟** 降低到 **2分钟**
- ✅ 运营人员可自主查询，无需依赖开发
- ✅ 提供追责依据，规范操作行为

---

## 3.1.3 数据变更对比 🔥🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 操作日志 → 详情                                      │
├─────────────────────────────────────────────────────┤
│ 操作人：admin                                        │
│ 操作时间：2025-12-01 14:30:25                       │
│ 操作模块：玩家管理                                   │
│ 目标对象：玩家ID 1234（张三）                        │
│ IP地址：192.168.1.100                               │
├─────────────────────────────────────────────────────┤
│ 数据变更对比：                                       │
│                                                     │
│ 字段      | 修改前    | 修改后                      │
│ ─────────┼──────────┼────────────────            │
│ 余额      | 100.00   | 200.00 (+100)              │
│ VIP等级   | 1        | 3 (+2)                     │
│ 状态      | 启用     | 启用 (无变化)               │
│                                                     │
│ 修改原因：客诉补偿                                   │
│                                                     │
│ [导出记录] [关闭]                                    │
└─────────────────────────────────────────────────────┘
```

### 技术实现
```sql
-- 审计日志表扩展
CREATE TABLE audit_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  operator_id INTEGER NOT NULL,
  module TEXT NOT NULL,
  action TEXT NOT NULL,
  target_id TEXT,
  description TEXT,
  before_data TEXT,  -- JSON格式存储修改前数据
  after_data TEXT,   -- JSON格式存储修改后数据
  ip_address TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 预期收益
- ✅ 问题追溯更精准（知道改了什么）
- ✅ 数据异常快速定位
- ✅ 完整的审计证据链

---

## 3.2.1 高危操作二次确认 🔥🔥🔥

### 功能设计
```
⚠️ 高危操作确认

即将执行：批量禁用 15 个玩家账户

此操作将导致：
  ✓ 15个玩家无法登录
  ✓ 正在进行的游戏将被中止
  ✓ 未提现余额将被冻结

为避免误操作，请输入管理员密码：
┌─────────────────────────────────────────────────┐
│ [__________]                                    │
└─────────────────────────────────────────────────┘

或输入"确认禁用"文本：
┌─────────────────────────────────────────────────┐
│ [__________]                                    │
└─────────────────────────────────────────────────┘

[取消] [确认执行]
```

### 预期收益
- ✅ 防止误操作导致严重后果
- ✅ 增加操作门槛，提升安全性

---

## 3.2.2 软删除与回收站 🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 回收站 - 已删除数据                                  │
├─────────────────────────────────────────────────────┤
│ 类型        | 数据      | 删除时间  | 删除人 | 操作  │
├─────────────────────────────────────────────────────┤
│ 玩家        | player123 | 12-13     | admin | [恢复]│
│ 代理        | agent456  | 12-12     | admin | [恢复]│
│ 提款申请    | WD-10001  | 12-11     | admin | [恢复]│
│                                                     │
│ 注：回收站数据保留30天后自动永久删除                 │
└─────────────────────────────────────────────────────┘
```

### 技术实现
```sql
-- 所有表增加软删除字段
ALTER TABLE players ADD COLUMN deleted_at DATETIME;
ALTER TABLE players ADD COLUMN deleted_by INTEGER;

-- 查询时过滤已删除数据
SELECT * FROM players WHERE deleted_at IS NULL;

-- 恢复数据
UPDATE players 
SET deleted_at = NULL, deleted_by = NULL 
WHERE id = ? AND deleted_at IS NOT NULL;
```

### 预期收益
- ✅ 数据误删除可恢复
- ✅ 保留30天缓冲期

---

# 第四章：真人视讯垂直功能 - 解决核心业务问题

## 📋 功能概述

真人视讯垂直功能是**真人荷官业务的核心功能**，包括异常处理、视频回放、风控检测等，直接影响玩家信任度和平台盈利能力。

### 核心价值
- 🎯 **异常处理能力** - 快速处理游戏异常，保护玩家权益
- 📹 **证据链完整性** - 视频回放提供不可辩驳的证据
- 🚨 **智能风控** - 自动识别套利、对打等异常行为
- ⚖️ **公平公正** - 完善的争议解决机制

---

## 功能清单

| 功能编号 | 功能名称 | 核心价值 | 优先级 |
|---------|---------|---------|--------|
| 4.1.1 | 改单/重结算 | 手动修改开奖结果并重新结算 | 🔥🔥🔥 |
| 4.1.2 | 手动作废局 | 将异常局设为作废并退款 | 🔥🔥🔥 |
| 4.1.3 | 补单/补结算 | 系统漏结算时手动补结算 | 🔥🔥🔥 |
| 4.1.4 | 局号级视频回放 | 输入局号调出视频录像 | 🔥🔥🔥 |
| 4.1.5 | 视频截图留证 | 回放时一键截图加水印 | 🔥🔥 |
| 4.1.6 | 客诉处理流程 | 从客诉直接跳转视频回放 | 🔥🔥 |
| 4.2.5 | 对打/刷水检测 | 自动识别套利行为 | 🔥🔥🔥 |
| 4.2.7 | 同IP多账号预警 | 检测同IP集中投注 | 🔥🔥 |

---

## 4.1.1 改单/重结算系统 🔥🔥🔥

### 业务场景
1. 荷官失误（发错牌、算错点数）
2. 视频卡顿（玩家看不清结果）
3. 传感器误判（识别错了牌面）
4. 系统Bug（赔付计算错误）

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 注单管理 → 异常处理                                  │
├─────────────────────────────────────────────────────┤
│ 搜索局号：[20251201-BJ001-158] [搜索]               │
├─────────────────────────────────────────────────────┤
│ 局详情                                               │
│ 桌台：百家乐-VIP1                                    │
│ 荷官：Alice                                          │
│ 时间：2025-12-01 14:30:25                           │
│ 开奖结果：庄赢（庄9点 vs 闲6点）                    │
│ 投注总额：¥125,000                                   │
│ 赔付总额：¥98,000                                    │
│ 平台盈亏：+¥27,000                                   │
├─────────────────────────────────────────────────────┤
│ 注单明细（共83笔）                                   │
│ ID    | 玩家    | 投注  | 金额    | 赔付          │
│ 1001  | 张三    | 庄    | ¥5,000  | ¥9,500       │
│ 1002  | 李四    | 闲    | ¥3,000  | ¥0           │
├─────────────────────────────────────────────────────┤
│ 异常处理操作                                         │
│                                                     │
│ [ ] 改单重结算                                       │
│     修改开奖结果为：[庄赢 ▼] → [闲赢 ▼]             │
│     原因：[荷官发错牌 ▼]                            │
│                                                     │
│ [ ] 作废本局                                         │
│     所有注单全额退款                                 │
│                                                     │
│ [确认操作] [取消]                                    │
└─────────────────────────────────────────────────────┘

⚠️ 操作确认
即将改单重结算：
  - 原结果：庄赢
  - 新结果：闲赢
  - 影响：83笔注单将重新计算
  - 预计调整金额：-¥54,000（平台多赔）

为避免误操作，请输入管理员密码：
[__________]

[取消] [确认重结算]
```

### 技术实现

**数据结构**
```sql
CREATE TABLE game_rounds (
  id INTEGER PRIMARY KEY,
  round_id TEXT UNIQUE NOT NULL,
  table_id INTEGER,
  dealer_id INTEGER,
  original_result TEXT,
  current_result TEXT,
  is_manual_settled INTEGER DEFAULT 0,
  manual_reason TEXT,
  video_url TEXT,
  start_time DATETIME,
  end_time DATETIME
);
```

**重结算流程**
```typescript
async function manualSettlement(roundId, newResult, reason) {
  // 1. 更新局结果
  await updateRound(roundId, newResult, reason)
  
  // 2. 查询该局所有注单
  const bets = await getBetsByRound(roundId)
  
  // 3. 逐个重新计算
  for (const bet of bets) {
    const newPayout = calculatePayout(bet, newResult)
    const diff = newPayout - bet.payout
    
    // 4. 更新注单
    await updateBet(bet.id, newPayout)
    
    // 5. 调整玩家余额（多退少补）
    if (diff !== 0) {
      await adjustPlayerBalance(bet.player_id, diff)
      await recordTransaction(
        bet.player_id, 
        'manual_settlement', 
        diff, 
        `局号${roundId}重结算调整`
      )
    }
  }
  
  // 6. 审计日志
  await logAudit('manual_settlement', roundId, {
    operator_id, reason, affected_bets: bets.length
  })
}
```

### 预期收益
- ✅ 解决真人视讯最核心的业务问题
- ✅ 提供完整的异常处理能力
- ✅ 增强玩家信任（公平公正）
- ✅ 减少客诉处理时间 **80%**

---

## 4.1.4 视频回放系统 🔥🔥🔥

### 业务场景
1. 玩家投诉开奖结果不公
2. 怀疑荷官作弊或失误
3. 需要调查异常投注
4. 内部审计和合规检查

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 注单管理 → 视频回放                                  │
├─────────────────────────────────────────────────────┤
│ 输入局号：[20251201-BJ001-158] [搜索]               │
├─────────────────────────────────────────────────────┤
│ 视频回放播放器                                       │
│ ┌─────────────────────────────────────────────────┐ │
│ │                                                 │ │
│ │     [视频播放区域]                               │ │
│ │                                                 │ │
│ │  ◀◀  ◀  ▶  ▶▶  [进度条]  [截图]               │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 局信息：                                             │
│ 时间：2025-12-01 14:30:25                           │
│ 桌台：百家乐-VIP1                                    │
│ 荷官：Alice                                          │
│ 开奖结果：庄赢（庄9点 vs 闲6点）                    │
│                                                     │
│ 关键时间点：                                         │
│ [14:30:28] 发牌开始                                 │
│ [14:30:45] 开牌瞬间 ← 当前播放                      │
│ [14:30:50] 结算完成                                 │
│                                                     │
│ 截图记录：                                           │
│ [截图1] 14:30:28 - 发牌瞬间                        │
│ [截图2] 14:30:45 - 开牌瞬间                        │
│                                                     │
│ [下载视频] [生成证据报告]                            │
└─────────────────────────────────────────────────────┘
```

### 技术方案

**视频存储**
- 使用 Cloudflare R2 存储视频
- 按局号组织：`/videos/2025/12/01/BJ001-158.mp4`
- 保留期：30天（可配置）

**成本估算**（以 Cloudflare R2 为例）
- 每局视频约 50MB
- 每天1000局 = 50GB
- 保留30天 = 1.5TB
- R2存储费用: $15/TB/月
- **预计月成本**: $22.5（可控）

**截图水印**
```typescript
function generateWatermark(screenshot) {
  watermark.add({
    image: screenshot,
    text: [
      `局号: ${roundId}`,
      `时间: ${timestamp}`,
      `操作人: ${operator}`,
      `真人荷官视讯系统`,
    ],
    position: 'bottom-right'
  })
}
```

### 预期收益
- ✅ 提供不可辩驳的证据
- ✅ 客诉处理更专业
- ✅ 内部审计有据可查
- ✅ 提升玩家信任度

---

## 4.2.5 对打/刷水检测 🔥🔥🔥

### 业务场景
套利玩家常用手法：
1. 在百家乐同时下注庄和闲
2. 利用洗码返水获利
3. 多个账户协同操作
4. 绕过单账户投注限制

### 检测算法
```typescript
// 对打检测算法
async function detectArbitrage() {
  // 1. 检测同一局中相反投注
  const suspiciousRounds = await db.query(`
    SELECT round_id, 
           GROUP_CONCAT(player_id) as players,
           SUM(CASE WHEN bet_on='banker' THEN amount ELSE 0 END) as banker_total,
           SUM(CASE WHEN bet_on='player' THEN amount ELSE 0 END) as player_total
    FROM bets
    WHERE created_at > datetime('now', '-1 hour')
    GROUP BY round_id
    HAVING banker_total > 0 AND player_total > 0
    AND ABS(banker_total - player_total) < 1000
  `)
  
  // 2. 检测IP关联
  for (const round of suspiciousRounds) {
    const players = round.players.split(',')
    const ips = await getPlayerIPs(players)
    
    // 如果多个玩家共享IP
    if (new Set(ips).size < players.length) {
      await createAlert({
        type: 'arbitrage_suspect',
        severity: 'high',
        description: `局号${round.round_id}检测到对打嫌疑`,
        players: players
      })
    }
  }
}
```

### 预警界面
```
┌─────────────────────────────────────────────────────┐
│ 风控管理 → 实时预警                                  │
├─────────────────────────────────────────────────────┤
│ ⚠️ 套利预警（实时）                                 │
│                                                     │
│ 【高危】对打嫌疑                                     │
│ 局号：20251201-BJ001-158                            │
│ 玩家：ID1234、ID5678、ID9012                        │
│ 详情：3个账户在同一局庄闲对打                        │
│ 庄投注：¥10,000                                      │
│ 闲投注：¥9,800（差异仅¥200）                        │
│ IP地址：192.168.1.100（相同）                       │
│                                                     │
│ [查看详情] [标记已处理] [冻结账户]                  │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 减少套利损失 **90%**
- ✅ 自动识别可疑行为
- ✅ 降低人工监控成本
- ✅ 保护平台利益

---

## 4.1.2 手动作废局 🔥🔥🔥

### 业务场景
- 视频卡顿导致无法正常开奖
- 技术故障导致游戏无法继续
- 荷官操作失误需要重新开局

### 处理流程
1. 查询该局所有注单
2. 将所有注单状态改为"已作废"
3. 将投注金额全额退回玩家余额
4. 记录作废原因和操作人
5. 通知相关玩家

### 技术实现
```typescript
async function voidGameRound(roundId, reason, operatorId) {
  // 1. 更新游戏局状态
  await db.execute(`
    UPDATE game_rounds 
    SET status = 'voided', void_reason = ?
    WHERE round_id = ?
  `, [reason, roundId])
  
  // 2. 查询该局所有注单
  const bets = await db.query(`
    SELECT * FROM bets WHERE round_id = ?
  `, [roundId])
  
  // 3. 退款并更新注单状态
  for (const bet of bets) {
    await db.execute(`
      UPDATE bets SET status = 'voided' WHERE id = ?
    `, [bet.id])
    
    // 退回投注金额
    await adjustPlayerBalance(bet.player_id, bet.amount)
    await recordTransaction(
      bet.player_id, 
      'void_refund', 
      bet.amount, 
      `局号${roundId}作废退款`
    )
  }
  
  // 4. 审计日志
  await logAudit('void_round', roundId, {
    operator_id: operatorId,
    reason: reason
  })
}
```

### 预期收益
- ✅ 快速处理异常局面
- ✅ 保护玩家利益
- ✅ 减少纠纷和投诉

---

## 4.2.7 同IP多账号预警 🔥🔥

### 检测逻辑
```typescript
async function detectSameIPAccounts() {
  // 检测1小时内同IP登录的账户数
  const suspiciousIPs = await db.query(`
    SELECT ip_address, 
           GROUP_CONCAT(DISTINCT player_id) as players,
           COUNT(DISTINCT player_id) as account_count
    FROM player_login_logs
    WHERE created_at > datetime('now', '-1 hour')
    GROUP BY ip_address
    HAVING account_count >= 3
  `)
  
  for (const record of suspiciousIPs) {
    await createAlert({
      type: 'same_ip_multiple_accounts',
      severity: 'medium',
      description: `IP ${record.ip_address} 在1小时内登录了${record.account_count}个账户`
    })
  }
}
```

### 预警界面
```
┌─────────────────────────────────────────────────────┐
│ 【中危】同IP多账号                                   │
│ IP地址：192.168.1.100                               │
│ 账户数：5个                                          │
│ 账户列表：                                           │
│   - ID1234 (张三)                                   │
│   - ID5678 (李四)                                   │
│   - ID9012 (王五)                                   │
│                                                     │
│ [查看详情] [批量冻结] [标记已处理]                  │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 自动识别多开账户
- ✅ 及时发现套利行为

---

# 第五章：数据与决策支持功能 - 让运营「懂」数据

## 📋 功能概述

数据与决策支持功能旨在**将数据转化为洞察**，通过多维报表、数据可视化、智能分析等手段，帮助运营人员做出更明智的决策。

### 核心价值
- 📊 **数据可视化** - 从数字表格到直观图表
- 🔍 **多维分析** - 从单一维度到多维交叉分析
- 🎯 **精准洞察** - 从经验判断到数据驱动
- 📈 **趋势预测** - 从事后分析到事前预警

---

## 功能清单

| 功能编号 | 功能名称 | 核心价值 | 优先级 |
|---------|---------|---------|--------|
| 5.1.1 | 实时数据看板 | 核心指标实时监控 | 🔥🔥🔥 |
| 5.1.2 | 盈亏日报 | 每日财务汇总 | 🔥🔥🔥 |
| 5.1.3 | 代理业绩报表 | 代理层级业绩统计 | 🔥🔥 |
| 5.1.4 | 玩家分析报表 | 玩家行为分析 | 🔥🔥 |
| 5.2.1 | 自定义报表 | 按需配置报表字段 | 🔥🔥 |
| 5.2.2 | 报表订阅 | 定时发送报表 | 🔥 |

---

## 5.1.1 实时数据看板 🔥🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 运营数据看板 - 实时                                  │
├─────────────────────────────────────────────────────┤
│ 今日核心指标 (更新时间：12-13 15:30)                │
│                                                     │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ │
│ │ 在线人数  │ │ 投注金额  │ │ 平台盈亏  │ │ 新增  │ │
│ │  1,234   │ │ ¥856K    │ │ +¥123K   │ │  45   │ │
│ │  ↑ 12%   │ │  ↑ 8%    │ │  ↑ 15%   │ │  ↓ 3% │ │
│ └──────────┘ └──────────┘ └──────────┘ └────────┘ │
│                                                     │
│ 充值/提款情况                                        │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 充值：¥456K (123笔)  待审核：15笔               │ │
│ │ 提款：¥234K (89笔)   待审核：23笔               │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 实时投注趋势 (最近24小时)                            │
│ ┌─────────────────────────────────────────────────┐ │
│ │     投注金额                                    │ │
│ │ 100K┤                                    ╭─     │ │
│ │  80K┤                          ╭────╮   │      │ │
│ │  60K┤                ╭───╮    │    │   │      │ │
│ │  40K┤         ╭──╮  │   │    │    │   │      │ │
│ │  20K┤   ╭──╮  │  │  │   │    │    │   │      │ │
│ │   0K└───┴──┴──┴──┴──┴───┴────┴────┴───┴──    │ │
│ │     00 04 08 12 16 20 24 04 08 12 16 20      │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 游戏类型分布 (今日投注)                              │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 百家乐 ████████████████████ 45%  ¥385K         │ │
│ │ 龙虎   ████████████ 28%  ¥240K                 │ │
│ │ 轮盘   ██████ 15%  ¥128K                       │ │
│ │ 骰宝   ████ 12%  ¥103K                         │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ [刷新] [导出] [自定义]                               │
└─────────────────────────────────────────────────────┘
```

### 技术实现
```typescript
// 实时数据API
app.get('/api/dashboard/realtime', async (c) => {
  const { DB } = c.env
  
  // 今日核心指标
  const today = new Date().toISOString().split('T')[0]
  
  const onlineUsers = await DB.prepare(`
    SELECT COUNT(DISTINCT player_id) as count
    FROM player_sessions
    WHERE last_activity > datetime('now', '-5 minutes')
  `).first()
  
  const todayBets = await DB.prepare(`
    SELECT 
      SUM(amount) as total_bet,
      SUM(payout - amount) as total_profit
    FROM bets
    WHERE DATE(created_at) = ?
  `).bind(today).first()
  
  const todayDeposits = await DB.prepare(`
    SELECT SUM(amount) as total, COUNT(*) as count
    FROM transactions
    WHERE type = 'deposit' AND DATE(created_at) = ?
  `).bind(today).first()
  
  return c.json({
    online_users: onlineUsers.count,
    today_bets: todayBets.total_bet,
    today_profit: todayBets.total_profit,
    deposits: todayDeposits
  })
})
```

### 预期收益
- ✅ 实时掌握业务状况
- ✅ 快速发现异常情况
- ✅ 数据驱动决策

---

## 5.1.2 盈亏日报 🔥🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 报表中心 → 盈亏日报                                  │
├─────────────────────────────────────────────────────┤
│ 日期：[2025-12-13] [查询]                           │
│                                                     │
│ 财务汇总                                             │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 充值金额：¥456,000 (123笔)                      │ │
│ │ 提款金额：¥234,000 (89笔)                       │ │
│ │ 投注金额：¥856,000                              │ │
│ │ 派彩金额：¥733,000                              │ │
│ │ 平台盈亏：+¥123,000                             │ │
│ │ 洗码费用：¥5,136                                │ │
│ │ 红利费用：¥2,568                                │ │
│ │ 净盈利：  +¥115,296                             │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 游戏类型明细                                         │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 游戏    | 投注额   | 派彩额   | 盈亏       | 占比│ │
│ ├─────────────────────────────────────────────────┤ │
│ │ 百家乐  | ¥385K   | ¥330K   | +¥55K     | 45% │ │
│ │ 龙虎    | ¥240K   | ¥205K   | +¥35K     | 28% │ │
│ │ 轮盘    | ¥128K   | ¥110K   | +¥18K     | 15% │ │
│ │ 骰宝    | ¥103K   | ¥88K    | +¥15K     | 12% │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ [导出PDF] [导出Excel] [发送邮件]                     │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 每日财务状况一目了然
- ✅ 快速生成财务报表

---

## 5.1.3 代理业绩报表 🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 报表中心 → 代理业绩                                  │
├─────────────────────────────────────────────────────┤
│ 筛选：                                               │
│ 代理层级：[全部 ▼]  时间范围：[本月 ▼]              │
│ [查询]                                               │
│                                                     │
│ 代理业绩排行                                         │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 代理    | 下级数 | 活跃数 | 投注额  | 佣金     │ │
│ ├─────────────────────────────────────────────────┤ │
│ │ agent01 | 45    | 32    | ¥125K  | ¥3,750   │ │
│ │ agent02 | 38    | 28    | ¥98K   | ¥2,940   │ │
│ │ agent03 | 52    | 35    | ¥156K  | ¥4,680   │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ [导出报表] [查看详情]                                │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 代理管理更高效
- ✅ 佣金结算有依据

---

## 5.1.4 玩家分析报表 🔥🔥

### 功能设计
```
┌─────────────────────────────────────────────────────┐
│ 数据分析 → 玩家分析                                  │
├─────────────────────────────────────────────────────┤
│ VIP等级分布                                          │
│ ┌─────────────────────────────────────────────────┐ │
│ │ VIP5 ██ 2%   (23人)   人均投注：¥156K          │ │
│ │ VIP4 ████ 5%   (58人)   人均投注：¥89K         │ │
│ │ VIP3 ████████ 12%   (145人)   人均投注：¥45K   │ │
│ │ VIP2 ████████████ 28%   (328人)   人均投注：¥18K│ │
│ │ VIP1 ██████████████████ 53%   (625人)  人均：¥5K│ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 玩家生命周期分析                                     │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 新注册 (7天内)：   125人   平均充值：¥2,300    │ │
│ │ 活跃玩家 (30天内)： 456人   平均充值：¥5,800   │ │
│ │ 沉睡玩家 (90天+)：  89人                        │ │
│ └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

### 预期收益
- ✅ 了解玩家结构
- ✅ 精准营销决策

---

# 附录：功能实施优先级建议

## 按价值与难度矩阵分类

### 第一优先级（高价值 + 低难度）- 立即实施
- ✅ 批量审核（1.1.2）
- ✅ 功能开关（2.2.6）
- ✅ 操作日志界面（3.1.4）
- ✅ 实时数据看板（5.1.1）

### 第二优先级（高价值 + 中难度）- 近期实施
- ✅ 批量状态变更（1.1.1）
- ✅ 系统参数配置（2.2.3）
- ✅ 维护模式（2.2.7）
- ✅ 数据变更对比（3.1.3）
- ✅ 盈亏日报（5.1.2）

### 第三优先级（高价值 + 高难度）- 规划实施
- ✅ 改单/重结算（4.1.1）
- ✅ 视频回放系统（4.1.4）
- ✅ 对打/刷水检测（4.2.5）

### 第四优先级（中价值）- 按需实施
- ✅ 高级筛选与搜索（1.1.3）
- ✅ Excel批量导入（1.1.8）
- ✅ 拒绝原因模版（2.1.3）
- ✅ 代理业绩报表（5.1.3）

---

# 总结

## 核心功能统计

| 功能类别 | 功能数量 | 高优先级 | 中优先级 | 低优先级 |
|---------|---------|---------|---------|---------|
| 效率类功能 | 7个 | 2个 | 5个 | 0个 |
| 流程与控制类 | 8个 | 3个 | 5个 | 0个 |
| 安全与风控 | 5个 | 3个 | 2个 | 0个 |
| 真人视讯 | 8个 | 6个 | 2个 | 0个 |
| 数据与决策 | 6个 | 2个 | 3个 | 1个 |
| **合计** | **34个** | **16个** | **17个** | **1个** |

## 预期总收益

### 效率提升
- 批量操作效率提升 **80%**
- 审核处理时间节省 **1.5-2小时/天**
- 查询效率提升 **90%**
- 数据导入效率提升 **90%**

### 安全保障
- 问题追溯时间从 **30分钟** 降到 **2分钟**
- 紧急响应时间从 **小时级** 降到 **秒级**
- 完整的审计证据链
- 高危操作保护机制

### 业务价值
- 客诉处理时间减少 **80%**
- 套利损失减少 **90%**
- 玩家信任度提升
- 平台盈利能力增强

---

**文档版本**: V1.0  
**创建日期**: 2025-12-13  
**维护者**: AI Assistant (Claude Code)  
**最后更新**: 2025-12-13

---

## 联系方式

- **Email**: cnwen123@gmail.com
- **GitHub主仓库**: https://github.com/CNWEN123/backstage-01A
- **GitHub备份**: https://github.com/CNWEN123/Live-dealer-backstage-01

## 相关文档

- `OPERATIONAL_FEATURES_ROADMAP.md` - 完整功能规划（含V2.1 vs V2.2对比）
- `FEATURES_COMPARISON_TABLE.md` - 功能对比表格
- `LIMIT_CONFIGURATION_GUIDE.md` - 限红配置功能指南
- `README.md` - 项目总览和部署指南

---

© 2025 真人荷官视讯系统. All Rights Reserved.
