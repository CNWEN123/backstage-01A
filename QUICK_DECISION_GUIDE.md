# 运营级管理后台 - 核心功能参考指南

**文档类型**: 功能详解文档  
**目标读者**: 项目经理、产品负责人、技术负责人  
**用途**: 了解核心功能实现细节与业务价值  
**版本**: V2.0  
**日期**: 2025-12-13

---

## 📋 文档说明

本文档详细介绍真人荷官视讯管理后台的**核心功能清单**与**实现细节**，帮助决策者：
- 快速了解各功能的业务价值
- 掌握技术实现方案
- 评估功能优先级

文档分为三大部分：
1. **功能汇总表** - 快速查看所有功能
2. **运营效率功能** - 批量操作、审核优化、数据管理
3. **真人视讯核心功能** - 异常处理、视频回放、风控增强

---

## 一、功能汇总表

### 📊 全部核心功能一览

| 分类 | 功能编号 | 功能名称 | 功能说明 | 优先级 |
|------|---------|---------|---------|--------|
| **批量操作** | 1.1.1 | 批量状态变更 | 批量启用/禁用玩家/代理账户 | 🔥🔥🔥 |
| | 1.1.2 | 批量审核 | 批量审核提款/洗码申请 | 🔥🔥🔥 |
| | 1.1.8 | Excel/CSV批量导入 | 批量导入玩家/代理数据 | 🔥🔥 |
| | 1.1.9 | 导入错误预检 | 上传前验证并提示错误 | 🔥🔥 |
| | 1.1.10 | 自定义字段导出 | 按需选择导出字段 | 🔥🔥 |
| **审核流程** | 2.1.3 | 拒绝原因模版 | 快速选择拒绝原因 | 🔥🔥 |
| | 2.1.5 | 历史违规记录 | 审核时显示历史情况 | 🔥🔥 |
| **系统控制** | 2.2.3 | 系统参数配置 | 后台配置业务参数 | 🔥🔥🔥 |
| | 2.2.4 | 文案配置 | 后台配置系统提示语 | 🔥🔥 |
| | 2.2.6 | 功能开关 | 一键开启/关闭系统功能 | 🔥🔥🔥 |
| | 2.2.7 | 维护模式 | 开启维护模式并显示公告 | 🔥🔥🔥 |
| **安全审计** | 3.1.2 | 详细操作记录 | 确保所有敏感操作均记录 | 🔥🔥🔥 |
| | 3.1.3 | 数据变更对比 | 记录修改前后的数据对比 | 🔥🔥🔥 |
| | 3.1.4 | 日志查询界面 | 可视化查询操作日志 | 🔥🔥🔥 |
| **异常处理** | 4.1.1 | 改单/重结算 | 手动修改开奖结果并重新结算 | 🔥🔥🔥 |
| | 4.1.2 | 手动作废局 | 将异常局设为作废并退款 | 🔥🔥🔥 |
| | 4.1.3 | 补单/补结算 | 系统漏结算时手动补结算 | 🔥🔥🔥 |
| **视频回放** | 4.1.4 | 局号级视频回放 | 输入局号调出视频录像 | 🔥🔥🔥 |
| | 4.1.5 | 视频截图留证 | 回放时一键截图加水印 | 🔥🔥 |
| | 4.1.6 | 客诉处理流程 | 从客诉直接跳转视频回放 | 🔥🔥 |
| **风控增强** | 4.2.5 | 对打/刷水检测 | 自动识别套利行为 | 🔥🔥🔥 |
| | 4.2.7 | 同IP多账号预警 | 检测同IP集中投注 | 🔥🔥 |

**优先级说明**:
- 🔥🔥🔥 **高优先级** - 核心业务必需，优先开发
- 🔥🔥 **中优先级** - 显著提升效率，建议开发
- 🔥 **低优先级** - 锦上添花，按需开发

---

## 二、运营效率功能详解

### 1️⃣ 批量审核（功能编号：1.1.2）

**当前痛点**:
- 每天有50-100笔提款申请需要审核
- 只能逐条点击"通过"或"拒绝"
- 运营人员每天花费2-3小时在重复点击上

**功能设计**:
```
提款审核页面
┌─────────────────────────────────────────┐
│ [√] 全选  待审核提款申请 (共127笔)       │
├─────────────────────────────────────────┤
│ [√] ID:001 | 玩家A | ¥500  | 2025-12-01 │
│ [√] ID:002 | 玩家B | ¥1200 | 2025-12-01 │
│ [√] ID:003 | 玩家C | ¥800  | 2025-12-01 │
│ ... (已选择 3 笔)                        │
├─────────────────────────────────────────┤
│ [批量通过] [批量拒绝] [取消选择]         │
└─────────────────────────────────────────┘
```

**技术实现**:
- **前端**: 添加全选checkbox和批量操作按钮
- **后端**: 新增批量更新API `PUT /api/withdrawals/batch`
- **审计**: 记录批量操作到audit_logs表

**预期收益**:
- ✅ 审核效率提升 **80%**
- ✅ 每天节省运营人员 **1.5-2小时**
- ✅ 减少重复劳动，提升工作满意度

---

### 2️⃣ 批量状态变更（功能编号：1.1.1）

**业务场景**:
- 活动推广时需批量调整玩家VIP等级
- 风控时需批量处理问题账户
- 代理管理时需批量启用/禁用账户

**功能设计**:
```
玩家管理 → 批量操作
┌─────────────────────────────────────────┐
│ 已选择 15 个玩家                         │
│                                         │
│ 批量操作：                               │
│ [批量启用] [批量禁用] [批量设置VIP等级]  │
│ [批量设置洗码方案] [批量转移代理]        │
└─────────────────────────────────────────┘

确认批量禁用？
⚠️ 即将禁用 15 个玩家账户
此操作将导致：
  - 玩家无法登录
  - 正在进行的游戏将被中止
  - 未提现余额将被冻结

[取消] [确认禁用]
```

**技术实现**:
- **前端**: 复选框多选 + 批量操作下拉菜单
- **后端**: API支持批量更新多个字段
- **确认机制**: 高危操作需二次确认

**预期收益**:
- 运营效率提升 **80%**
- 活动推广响应更快
- 风控处理更高效

---

### 3️⃣ 功能开关（功能编号：2.2.6）

**当前痛点**:
- 发现重大Bug需要紧急关闭功能时，必须修改代码重新部署
- 系统维护时无法临时关闭充值/提款入口
- 夜间出现问题时，开发人员需要紧急上线

**功能设计**:
```
系统设置 → 功能开关
┌─────────────────────────────────────────┐
│ 功能开关管理                             │
├─────────────────────────────────────────┤
│ [√] 充值功能     [启用中] [关闭]        │
│     关闭后玩家无法进行充值操作           │
│                                         │
│ [√] 提款功能     [启用中] [关闭]        │
│     关闭后玩家无法提交提款申请           │
│                                         │
│ [√] 游戏投注     [启用中] [关闭]        │
│     关闭后玩家无法进行游戏投注           │
│                                         │
│ [ ] 代理注册     [已关闭] [启用]        │
│     关闭后无法注册新代理                 │
└─────────────────────────────────────────┘
```

**技术实现**:
- **数据库**: 新增`system_config`表存储开关状态
- **后端**: API调用前检查对应功能开关
- **前端**: 设置页面增加开关管理界面

**预期收益**:
- ✅ 紧急情况下 **秒级响应**
- ✅ 避免紧急部署带来的风险
- ✅ 运营人员可自主控制，无需等待开发

---

### 4️⃣ 维护模式（功能编号：2.2.7）

**业务场景**:
- 系统升级维护时需要通知玩家
- 数据库迁移时需要暂停服务
- 重大功能上线时需要保护数据

**功能设计**:
```
系统设置 → 维护模式
┌─────────────────────────────────────────┐
│ 维护模式控制                             │
├─────────────────────────────────────────┤
│ [ ] 开启维护模式                         │
│                                         │
│ 维护公告：                               │
│ ┌─────────────────────────────────────┐ │
│ │ 系统维护中，预计2小时后恢复...      │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 预计恢复时间：[2025-12-01 16:00]        │
│                                         │
│ 维护期间效果：                           │
│ ✓ 玩家前端显示维护公告                   │
│ ✓ 禁止玩家登录                          │
│ ✓ 管理员可正常登录                      │
│                                         │
│ [保存] [预览效果]                        │
└─────────────────────────────────────────┘
```

**技术实现**:
- **system_config表**: `maintenance_mode`, `maintenance_message`, `maintenance_until`
- **中间件拦截**: 检测维护模式，非管理员返回维护页面
- **定时任务**: 自动恢复服务

**预期收益**:
- 系统维护时体验更专业
- 避免玩家在维护期间操作导致数据异常
- 自动定时恢复，无需手动干预

---

### 5️⃣ 操作日志界面（功能编号：3.1.4）

**当前痛点**:
- 出现数据异常时，无法快速查询"谁改了什么"
- 需要开发人员直接查询数据库
- 没有可视化界面，追溯困难

**功能设计**:
```
系统设置 → 操作日志
┌─────────────────────────────────────────┐
│ 筛选条件：                               │
│ 操作人：[admin ▼]  模块：[全部 ▼]       │
│ 时间：[最近7天 ▼]  操作：[全部 ▼]       │
│ [查询] [重置]                            │
├─────────────────────────────────────────┤
│ 操作日志列表                             │
├─────────────────────────────────────────┤
│ 时间 | 操作人 | 模块 | 操作 | 详情      │
├─────────────────────────────────────────┤
│ 12-01 14:30 | admin | 玩家 | 修改 |     │
│ 玩家ID:1234 余额：100.00 → 200.00       │
│ [查看详情]                               │
├─────────────────────────────────────────┤
│ 12-01 14:25 | admin | 财务 | 审核 |     │
│ 提款ID:5678 状态：pending → approved    │
│ [查看详情]                               │
└─────────────────────────────────────────┘
```

**技术实现**:
- **前端**: 新增操作日志查询页面
- **后端**: 新增查询API `GET /api/audit-logs`
- **功能**: 支持按操作人、模块、时间筛选

**预期收益**:
- ✅ 问题追溯时间从 **30分钟** 降低到 **2分钟**
- ✅ 运营人员可自主查询，无需依赖开发
- ✅ 提供追责依据，规范操作行为

---

### 6️⃣ 数据变更对比（功能编号：3.1.3）

**业务价值**:
- 精准定位数据异常原因
- 完整的审计证据链
- 快速识别误操作

**功能设计**:
```
操作日志 → 详情
┌─────────────────────────────────────────┐
│ 操作详情                                 │
├─────────────────────────────────────────┤
│ 操作人：admin                            │
│ 操作时间：2025-12-01 14:30:25           │
│ 操作模块：玩家管理                       │
│ 操作类型：修改                           │
│ 目标对象：玩家ID 1234（张三）           │
│ IP地址：192.168.1.100                   │
├─────────────────────────────────────────┤
│ 数据变更对比：                           │
│                                         │
│ 字段      | 修改前    | 修改后          │
│ ─────────┼──────────┼────────────────│
│ 余额      | 100.00   | 200.00 (+100)  │
│ VIP等级   | 1        | 3 (+2)         │
│ 状态      | 启用     | 启用 (无变化)   │
│                                         │
│ 修改原因：客诉补偿                       │
│                                         │
│ [导出记录] [关闭]                        │
└─────────────────────────────────────────┘
```

**技术实现**:
- **audit_logs表扩展**: 新增`before_data`和`after_data`字段（JSON格式）
- **中间件**: 在数据修改前记录原始值
- **前端**: 对比展示修改前后的差异

**预期收益**:
- 问题追溯更精准（知道改了什么）
- 数据异常快速定位
- 完整的审计证据链

---

### 7️⃣ 系统参数配置（功能编号：2.2.3）

**当前痛点**:
- 业务参数硬编码在代码中
- 调整参数需要修改代码重新部署
- 运营无法自主调整业务规则

**功能设计**:
```
系统设置 → 参数配置
┌─────────────────────────────────────────┐
│ 业务参数配置                             │
├─────────────────────────────────────────┤
│ 财务相关：                               │
│   最小充值金额：    [100] 元            │
│   最小提款金额：    [200] 元            │
│   提款手续费率：    [0.5] %             │
│   每日提款次数限制：[3] 次              │
│                                         │
│ 游戏相关：                               │
│   默认洗码率：      [0.6] %             │
│   最大投注金额：    [50000] 元          │
│                                         │
│ 联系方式：                               │
│   客服电话：        [400-xxx-xxxx]      │
│   客服微信：        [kefu_xxx]          │
│   在线客服链接：    [https://...]       │
│                                         │
│ 文案配置：                               │
│   余额不足提示：    [您的余额不足...]   │
│   提款成功提示：    [提款申请已提交...] │
│                                         │
│ [保存配置] [恢复默认]                    │
└─────────────────────────────────────────┘
```

**技术实现**:
- **system_config表**: key-value结构存储所有配置
- **API**: `GET /api/system-config` 和 `PUT /api/system-config`
- **缓存**: 配置项缓存到内存，避免频繁查询

**预期收益**:
- 无需修改代码即可调整业务参数
- 运营可自主配置，响应更快
- 减少硬编码，提升系统灵活性

---

### 8️⃣ Excel/CSV批量导入（功能编号：1.1.8）

**业务场景**:
- 从旧系统迁移玩家数据
- 批量导入代理账户
- 批量更新玩家信息

**功能设计**:
```
玩家管理 → 批量导入
┌─────────────────────────────────────────┐
│ 批量导入玩家                             │
├─────────────────────────────────────────┤
│ 1. 下载模板                              │
│    [下载Excel模板] [下载CSV模板]        │
│                                         │
│ 2. 上传文件                              │
│    [选择文件] players_import.xlsx       │
│                                         │
│ 3. 预检结果                              │
│    ✅ 共200条记录                        │
│    ✅ 格式验证通过 195条                 │
│    ⚠️ 格式错误 5条                      │
│                                         │
│    错误详情：                            │
│    第12行：手机号格式错误                │
│    第45行：VIP等级超出范围               │
│    第78行：代理ID不存在                  │
│    ...                                  │
│                                         │
│ [修正错误] [忽略错误继续导入]            │
└─────────────────────────────────────────┘
```

**技术实现**:
- **文件解析**: 使用xlsx/csv解析库
- **验证规则**: 手机号、邮箱、ID外键等
- **分批导入**: 避免大量数据一次性插入

**预期收益**:
- 数据迁移效率提升 **90%**
- 减少手动录入错误
- 支持大批量数据导入

---

## 三、真人视讯核心功能详解

### 1️⃣ 改单/重结算系统（功能编号：4.1.1）⭐⭐⭐

**业务场景**:
1. 荷官失误（发错牌、算错点数）
2. 视频卡顿（玩家看不清结果）
3. 传感器误判（识别错了牌面）
4. 系统Bug（赔付计算错误）

**功能设计**:
```
注单管理 → 异常处理
┌─────────────────────────────────────────┐
│ 搜索局号：[20251201-BJ001-158] [搜索]   │
├─────────────────────────────────────────┤
│ 局详情                                   │
│ 桌台：百家乐-VIP1                        │
│ 荷官：Alice                              │
│ 时间：2025-12-01 14:30:25               │
│ 开奖结果：庄赢（庄9点 vs 闲6点）        │
│ 投注总额：¥125,000                       │
│ 赔付总额：¥98,000                        │
│ 平台盈亏：+¥27,000                       │
├─────────────────────────────────────────┤
│ 注单明细（共83笔）                       │
│ ID    | 玩家    | 投注  | 金额    | 赔付  │
│ 1001  | 张三    | 庄    | ¥5,000  | ¥9,500│
│ 1002  | 李四    | 闲    | ¥3,000  | ¥0    │
│ ...   | ...     | ...   | ...     | ...   │
├─────────────────────────────────────────┤
│ 异常处理操作                             │
│                                         │
│ [ ] 改单重结算                           │
│     修改开奖结果为：                     │
│     [庄赢 ▼] → [闲赢 ▼]                 │
│     原因：[荷官发错牌 ▼]                │
│                                         │
│ [ ] 作废本局                             │
│     所有注单全额退款                     │
│     原因：[视频卡顿 ▼]                  │
│                                         │
│ [ ] 手动补结算                           │
│     触发补结算流程                       │
│                                         │
│ [确认操作] [取消]                        │
└─────────────────────────────────────────┘

⚠️ 操作确认
即将改单重结算：
  - 原结果：庄赢
  - 新结果：闲赢
  - 影响：83笔注单将重新计算
  - 预计调整金额：-¥54,000（平台多赔）

为避免误操作，请输入管理员密码：
[__________]

[取消] [确认重结算]
```

**技术实现要点**:

1. **数据结构**:
```sql
-- 游戏局表
CREATE TABLE game_rounds (
  id INTEGER PRIMARY KEY,
  round_id TEXT UNIQUE NOT NULL,  -- 局号
  table_id INTEGER,               -- 桌台ID
  dealer_id INTEGER,              -- 荷官ID
  original_result TEXT,           -- 原始结果
  current_result TEXT,            -- 当前结果
  is_manual_settled INTEGER DEFAULT 0,
  manual_reason TEXT,             -- 改单原因
  video_url TEXT,                 -- 视频URL
  start_time DATETIME,
  end_time DATETIME
);
```

2. **重结算流程**:
```typescript
async function manualSettlement(roundId, newResult, reason) {
  // 1. 更新局结果
  await updateRound(roundId, newResult, reason)
  
  // 2. 查询该局所有注单
  const bets = await getBetsByRound(roundId)
  
  // 3. 逐个重新计算
  for (const bet of bets) {
    const newPayout = calculatePayout(bet, newResult)
    const diff = newPayout - bet.payout
    
    // 4. 更新注单
    await updateBet(bet.id, newPayout)
    
    // 5. 调整玩家余额（多退少补）
    if (diff !== 0) {
      await adjustPlayerBalance(bet.player_id, diff)
      await recordTransaction(bet.player_id, 
        'manual_settlement', diff, 
        `局号${roundId}重结算调整`
      )
    }
  }
  
  // 6. 审计日志
  await logAudit('manual_settlement', roundId, {
    operator_id, reason, affected_bets: bets.length
  })
}
```

**预期收益**:
- 解决真人视讯最核心的业务问题
- 提供完整的异常处理能力
- 增强玩家信任（公平公正）
- 减少客诉处理时间 80%

---

### 2️⃣ 视频回放系统（功能编号：4.1.4）⭐⭐⭐

**业务场景**:
1. 玩家投诉开奖结果不公
2. 怀疑荷官作弊或失误
3. 需要调查异常投注
4. 内部审计和合规检查

**功能设计**:
```
注单管理 → 视频回放
┌─────────────────────────────────────────┐
│ 输入局号：[20251201-BJ001-158] [搜索]   │
├─────────────────────────────────────────┤
│ 视频回放播放器                           │
│ ┌─────────────────────────────────────┐ │
│ │                                     │ │
│ │     [视频播放区域]                   │ │
│ │                                     │ │
│ │  ◀◀  ◀  ▶  ▶▶  [进度条]  [截图]   │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 局信息：                                 │
│ 时间：2025-12-01 14:30:25               │
│ 桌台：百家乐-VIP1                        │
│ 荷官：Alice                              │
│ 开奖结果：庄赢（庄9点 vs 闲6点）        │
│                                         │
│ 关键时间点：                             │
│ [14:30:28] 发牌开始                     │
│ [14:30:45] 开牌瞬间 ← 当前播放          │
│ [14:30:50] 结算完成                     │
│                                         │
│ 截图记录：                               │
│ [截图1] 14:30:28 - 发牌瞬间            │
│ [截图2] 14:30:45 - 开牌瞬间            │
│                                         │
│ [下载视频] [生成证据报告]               │
└─────────────────────────────────────────┘
```

**技术方案**:

1. **视频存储**:
   - 使用 Cloudflare R2 存储视频
   - 按局号组织：`/videos/2025/12/01/BJ001-158.mp4`
   - 保留期：30天（可配置）

2. **视频切片**:
   - 每局单独存储（约2-5分钟）
   - 生成缩略图和关键帧
   - 使用CDN加速播放

3. **截图水印**:
```typescript
function generateWatermark(screenshot) {
  // 添加水印信息
  watermark.add({
    image: screenshot,
    text: [
      `局号: ${roundId}`,
      `时间: ${timestamp}`,
      `操作人: ${operator}`,
      `真人荷官视讯系统`,
    ],
    position: 'bottom-right'
  })
}
```

**成本估算**（以 Cloudflare R2 为例）:
- 每局视频约 50MB
- 每天1000局 = 50GB
- 保留30天 = 1.5TB
- R2存储费用: $15/TB/月
- **预计月成本**: $22.5（可控）

**预期收益**:
- 提供不可辩驳的证据
- 客诉处理更专业
- 内部审计有据可查
- 提升玩家信任度

---

### 3️⃣ 对打/刷水检测（功能编号：4.2.5）⭐⭐⭐

**业务场景**:
套利玩家常用手法：
1. 在百家乐同时下注庄和闲
2. 利用洗码返水获利
3. 多个账户协同操作
4. 绕过单账户投注限制

**检测算法**:
```typescript
// 对打检测算法
async function detectArbitrage() {
  // 1. 检测同一局中相反投注
  const suspiciousRounds = await db.query(`
    SELECT round_id, 
           GROUP_CONCAT(player_id) as players,
           SUM(CASE WHEN bet_on='banker' THEN amount ELSE 0 END) as banker_total,
           SUM(CASE WHEN bet_on='player' THEN amount ELSE 0 END) as player_total
    FROM bets
    WHERE created_at > datetime('now', '-1 hour')
    GROUP BY round_id
    HAVING banker_total > 0 AND player_total > 0
    AND ABS(banker_total - player_total) < 1000  -- 金额接近
  `)
  
  // 2. 检测IP关联
  for (const round of suspiciousRounds) {
    const players = round.players.split(',')
    const ips = await getPlayerIPs(players)
    
    // 如果多个玩家共享IP
    if (new Set(ips).size < players.length) {
      await createAlert({
        type: 'arbitrage_suspect',
        severity: 'high',
        description: `局号${round.round_id}检测到对打嫌疑`,
        players: players,
        round_id: round.round_id
      })
    }
  }
}
```

**预警界面**:
```
风控管理 → 实时预警
┌─────────────────────────────────────────┐
│ ⚠️ 套利预警（实时）                     │
├─────────────────────────────────────────┤
│ 【高危】对打嫌疑                         │
│ 局号：20251201-BJ001-158                │
│ 玩家：ID1234、ID5678、ID9012            │
│ 详情：3个账户在同一局庄闲对打            │
│ 庄投注：¥10,000                          │
│ 闲投注：¥9,800（差异仅¥200）            │
│ IP地址：192.168.1.100（相同）           │
│ 时间：2025-12-01 14:30                  │
│                                         │
│ [查看详情] [标记已处理] [冻结账户]      │
├─────────────────────────────────────────┤
│ 【中危】高频投注                         │
│ 玩家：ID3456                             │
│ 详情：1小时内投注85次                    │
│ ...                                     │
└─────────────────────────────────────────┘
```

**预期收益**:
- 减少套利损失 **90%**
- 自动识别可疑行为
- 降低人工监控成本
- 保护平台利益

---

### 4️⃣ 手动作废局（功能编号：4.1.2）

**业务场景**:
- 视频卡顿导致无法正常开奖
- 技术故障导致游戏无法继续
- 荷官操作失误需要重新开局

**处理流程**:
1. 查询该局所有注单
2. 将所有注单状态改为"已作废"
3. 将投注金额全额退回玩家余额
4. 记录作废原因和操作人
5. 通知相关玩家

**技术实现**:
```typescript
async function voidGameRound(roundId, reason, operatorId) {
  // 1. 更新游戏局状态
  await db.execute(`
    UPDATE game_rounds 
    SET status = 'voided', void_reason = ?, voided_by = ?, voided_at = CURRENT_TIMESTAMP
    WHERE round_id = ?
  `, [reason, operatorId, roundId])
  
  // 2. 查询该局所有注单
  const bets = await db.query(`SELECT * FROM bets WHERE round_id = ?`, [roundId])
  
  // 3. 退款并更新注单状态
  for (const bet of bets) {
    await db.execute(`
      UPDATE bets SET status = 'voided', payout = 0 WHERE id = ?
    `, [bet.id])
    
    // 退回投注金额
    await adjustPlayerBalance(bet.player_id, bet.amount)
    await recordTransaction(bet.player_id, 'void_refund', bet.amount, 
      `局号${roundId}作废退款`
    )
  }
  
  // 4. 审计日志
  await logAudit('void_round', roundId, {
    operator_id: operatorId,
    reason: reason,
    affected_bets: bets.length
  })
}
```

**预期收益**:
- 快速处理异常局面
- 保护玩家利益
- 减少纠纷和投诉

---

### 5️⃣ 同IP多账号预警（功能编号：4.2.7）

**检测逻辑**:
```typescript
async function detectSameIPAccounts() {
  // 检测1小时内同IP登录的账户数
  const suspiciousIPs = await db.query(`
    SELECT ip_address, 
           GROUP_CONCAT(DISTINCT player_id) as players,
           COUNT(DISTINCT player_id) as account_count
    FROM player_login_logs
    WHERE created_at > datetime('now', '-1 hour')
    GROUP BY ip_address
    HAVING account_count >= 3  -- 3个以上账户
  `)
  
  for (const record of suspiciousIPs) {
    await createAlert({
      type: 'same_ip_multiple_accounts',
      severity: 'medium',
      description: `IP ${record.ip_address} 在1小时内登录了${record.account_count}个账户`,
      details: {
        ip: record.ip_address,
        players: record.players.split(','),
        count: record.account_count
      }
    })
  }
}
```

**预警界面**:
```
风控管理 → 实时预警
┌─────────────────────────────────────────┐
│ 【中危】同IP多账号                       │
│ IP地址：192.168.1.100                   │
│ 账户数：5个                              │
│ 账户列表：                               │
│   - ID1234 (张三)                       │
│   - ID5678 (李四)                       │
│   - ID9012 (王五)                       │
│   - ID3456 (赵六)                       │
│   - ID7890 (钱七)                       │
│                                         │
│ 可疑行为：                               │
│   - 5个账户均在最近1小时内登录           │
│   - 部分账户有对打嫌疑                   │
│                                         │
│ [查看详情] [批量冻结] [标记已处理]      │
└─────────────────────────────────────────┘
```

**预期收益**:
- 自动识别多开账户
- 及时发现套利行为
- 保护平台利益

---

## 四、技术依赖与风险评估

### ⚠️ 核心技术依赖

| 依赖项 | 说明 | 风险等级 | 应对方案 |
|--------|------|---------|---------|
| **视频存储方案** | 需确定R2/S3等存储服务 | 🔴 高 | 提前完成方案选型和测试 |
| **game_rounds表** | 需设计完整的游戏局数据结构 | 🟡 中 | 提前完成数据建模 |
| **审计日志表结构** | 需扩展字段存储before/after | 🟡 中 | 提前设计好表结构 |
| **参数配置存储** | 新增system_config表 | 🟢 低 | 简单key-value存储 |
| **前端状态管理** | 批量操作需管理选中状态 | 🟡 中 | 使用成熟的状态管理方案 |

**关键决策点**:
- ⚠️ **视频回放系统**: 必须确定存储方案和预算后再开发
- ⚠️ **game_rounds表**: 需要与游戏平台方确认数据结构
- ⚠️ **视频录制**: 需确认游戏平台是否支持视频录制功能

---

## 五、常见问题 FAQ

### Q1: 视频存储会很贵吗？

**A**: 成本可控。以Cloudflare R2为例：
- 每局视频约 50MB
- 每天1000局 = 50GB
- 保留30天 = 1.5TB
- R2存储费用: $15/TB/月
- **预计月成本**: $22.5

**优化方案**:
- 只保留争议局的视频
- 自动删除30天前的视频
- 使用压缩编码

---

### Q2: 可以只开发其中某几个功能吗？

**A**: 可以！本文档提供的是全功能清单，您可以根据实际需求选择任意功能点单独开发。

**建议优先开发**:
- **批量审核** - 最立竿见影
- **功能开关** - 最紧急必需
- **操作日志** - 最基础保障

---

### Q3: 改单/重结算功能会有风险吗？

**A**: 有风险，但可控：

**主要风险**:
- 操作失误导致错误结算
- 恶意操作导致平台损失

**风控措施**:
- ✅ 二次密码确认
- ✅ 详细审计日志
- ✅ 权限严格控制（仅超管可操作）
- ✅ 操作前预览影响范围
- ✅ 操作后不可撤销

---

### Q4: 需要停机维护吗？

**A**: 大部分功能**无需停机**：

**无需停机**:
- 批量操作功能
- 功能开关
- 操作日志
- 系统参数配置

**需要短暂维护**（5-10分钟）:
- 数据库schema变更
- 重大功能上线

---

### Q5: 这些功能都必须开发吗？

**A**: 不是，可以按优先级分批开发：

**核心必需（建议优先）**:
- 批量审核
- 功能开关
- 操作日志
- 改单/重结算

**重要功能（建议第二批）**:
- 批量状态变更
- 维护模式
- 数据变更对比
- 视频回放

**优化功能（按需开发）**:
- Excel导入导出
- 拒绝原因模版
- 对打检测

---

## 六、联系方式

### 📞 技术支持

- **Email**: cnwen123@gmail.com
- **GitHub主仓库**: https://github.com/CNWEN123/backstage-01A
- **GitHub备份**: https://github.com/CNWEN123/Live-dealer-backstage-01

### 📚 相关文档

- `OPERATIONAL_FEATURES_ROADMAP.md` - 完整功能规划（含优先级分析）
- `FEATURES_COMPARISON_TABLE.md` - 功能对比表格（V2.1 vs V2.2）
- `LIMIT_CONFIGURATION_GUIDE.md` - 限红配置功能指南
- `README.md` - 项目总览和部署指南

---

## 七、附录：功能编号索引

### 快速查找功能详情

| 功能编号 | 功能名称 | 分类 | 优先级 | 详细位置 |
|---------|---------|------|--------|---------|
| 1.1.1 | 批量状态变更 | 批量操作 | 🔥🔥🔥 | §二-2 |
| 1.1.2 | 批量审核 | 批量操作 | 🔥🔥🔥 | §二-1 |
| 1.1.8 | Excel/CSV批量导入 | 数据管理 | 🔥🔥 | §二-8 |
| 1.1.9 | 导入错误预检 | 数据管理 | 🔥🔥 | §二-8 |
| 1.1.10 | 自定义字段导出 | 数据管理 | 🔥🔥 | - |
| 2.1.3 | 拒绝原因模版 | 审核流程 | 🔥🔥 | - |
| 2.1.5 | 历史违规记录 | 审核流程 | 🔥🔥 | - |
| 2.2.3 | 系统参数配置 | 系统控制 | 🔥🔥🔥 | §二-7 |
| 2.2.4 | 文案配置 | 系统控制 | 🔥🔥 | §二-7 |
| 2.2.6 | 功能开关 | 系统控制 | 🔥🔥🔥 | §二-3 |
| 2.2.7 | 维护模式 | 系统控制 | 🔥🔥🔥 | §二-4 |
| 3.1.2 | 详细操作记录 | 安全审计 | 🔥🔥🔥 | - |
| 3.1.3 | 数据变更对比 | 安全审计 | 🔥🔥🔥 | §二-6 |
| 3.1.4 | 日志查询界面 | 安全审计 | 🔥🔥🔥 | §二-5 |
| 4.1.1 | 改单/重结算 | 异常处理 | 🔥🔥🔥 | §三-1 |
| 4.1.2 | 手动作废局 | 异常处理 | 🔥🔥🔥 | §三-4 |
| 4.1.3 | 补单/补结算 | 异常处理 | 🔥🔥🔥 | - |
| 4.1.4 | 局号级视频回放 | 视频回放 | 🔥🔥🔥 | §三-2 |
| 4.1.5 | 视频截图留证 | 视频回放 | 🔥🔥 | §三-2 |
| 4.1.6 | 客诉处理流程 | 视频回放 | 🔥🔥 | - |
| 4.2.5 | 对打/刷水检测 | 风控增强 | 🔥🔥🔥 | §三-3 |
| 4.2.7 | 同IP多账号预警 | 风控增强 | 🔥🔥 | §三-5 |

---

**文档版本**: V2.0  
**创建日期**: 2025-12-13  
**维护者**: AI Assistant (Claude Code)  
**最后更新**: 2025-12-13

---

© 2025 真人荷官视讯系统. All Rights Reserved.
